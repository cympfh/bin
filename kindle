#!/bin/bash

usage() {
    cat << EOM
Usage: kindle [-n] [-S <name>] [--convert] <pdf-url>

Usage: kindle [-n] arxiv <abs-url>

  The title and the pdf url are complemented automatically

  Example:
    kindle arxiv https://arxiv.org/abs/1201.01234

Options:
  -n    dry-run
EOM
    exit 0
}

unwords() {
    echo "$@" | tr ' ' '_'
}

arxiv-title() {
    curl -s "$1" | grep '^<title>' | sed 's,</\?title>,,g'
}

arxiv-pdf() {
    echo "$1" | sed 's,/abs/,/pdf/,g; s/$/.pdf/g'
}

if [ $# -eq 0 -o "_$1" = "_-h" -o "_$1" = "_--help" ]; then
    usage
fi

TO=cympfh_40@kindle.com
DIR=$(mktemp -d)
rm -rf "$DIR"
mkdir "$DIR"

# argparse
OUTPUT="--trust-server-names"
SUBJECT=""
TARGET=""
DRYRUN=0

while [ "_$1" != "_" ]; do
    case $1 in

        # pdf name
        -s | -S )
            S=$(unwords "$2")
            case $S in
                *.pdf )
                    OUTPUT="-O $DIR/$S"
                    ;;
                * )
                    OUTPUT="-O $DIR/$S.pdf"
                    ;;
            esac
            shift 2
            ;;

        # convert to .azw
        --convert | -C )
            SUBJECT=convert
            shift
            ;;

        arxiv | --arxiv )
            S=$(arxiv-title "$2")
            S=$(unwords "$S")
            OUTPUT="-O $DIR/$S.pdf"
            TARGET=$(arxiv-pdf "$2")
            shift 2
            ;;

        -n | --dry-run )
            DRYRUN=1
            shift
            ;;

        * )
            TARGET=$1
            shift
    esac
done

# parse target
case $TARGET in
    http* )
        # fetch
        URL=$TARGET
        echo "download from $URL"
        UA='Mozilla/5.0 (X11; Linux x86_64; rv:30.0) Gecko/20100101 Firefox/30.0'
        if [ $DRYRUN -eq 1 ]; then
            echo wget -P "$DIR" -U "$UA" $OUTPUT "$URL"
        else
            wget -P "$DIR" -U "$UA" $OUTPUT "$URL"
        fi
        for f in $DIR/*.pdf; do
            TARGET=$f
            break
        done
        ;;
    * )
        ;;
esac

# sendmail
echo "sending $TARGET"
if [ $DRYRUN -eq 1 ]; then
    echo mutt -s "$SUBJECT" "$TO" -a "$TARGET"
else
    mutt -s "$SUBJECT" "$TO" -a "$TARGET" <<< "Ok, Amazon"
fi

rm -rf "$DIR"
