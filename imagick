#!/bin/bash

if ( ! type magick >/dev/null 2>&1 ); then
  echo "Error: magick command not found" >&2
  exit 2
fi

usage() {
  cat <<EOM
Usage: imagick <subcommand> [options] <image>

subcommand
  level60         Adjust image levels to 60%
  level70         Adjust image levels to 70%
  level80         Adjust image levels to 80%
  x2              Resize image to 2x
  x4              Resize image to 4x
  ai -p <prompt>  Generate ImageMagick command using AI based on prompt
EOM
}

SUBCOMMAND="$1"
shift
PROMPT=""
OUTPUT=""
while getopts "p:o:" opt; do
  case $opt in
    p)
      PROMPT="$OPTARG"
      ;;
    o)
      OUTPUT="$OPTARG"
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND-1))

IMAGE="$1"
if [ -z "$OUTPUT" ]; then
  OUTPUT="${IMAGE%.*}_$SUBCOMMAND.${IMAGE##*.}"
fi

ai_subcommand() {
  if ( ! type codegen >/dev/null 2>&1 ); then
    echo "Error: codegen command not found (required for 'ai' subcommand)" >&2
    exit 2
  fi

  if [ -z "$PROMPT" ]; then
    echo "Error: -p option is required for 'ai' subcommand" >&2
    echo "Usage: imagick ai -p \"prompt\" [-o output] <image>" >&2
    exit 1
  fi

  if [ -z "$IMAGE" ]; then
    echo "Error: image file is required" >&2
    exit 1
  fi

  # Auto-generate output filename if not specified
  if [ -z "$OUTPUT" ]; then
    OUTPUT="${IMAGE%.*}_ai.${IMAGE##*.}"
  fi

  # Generate magick command using codegen
  echo "Generating ImageMagick command..." >&2
  MAGICK_CMD=$(echo "ImageMagick の magick コマンドを1つ生成してください。

入力ファイル: $IMAGE
出力ファイル: $OUTPUT
要求: $PROMPT

magick コマンドのみを1行で出力してください。説明やコードブロックは不要です。
例: magick input.png -fuzz 10% -transparent green output.png" | codegen chat -L bash -q)

  if [ $? -ne 0 ]; then
    echo "Error: Failed to generate command" >&2
    exit 1
  fi

  echo "Generated command: $MAGICK_CMD" >&2
  echo -n "Are you sure to execute this command? (y/n): " >&2
  read -r CONFIRM
  if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
    echo "Aborted by user." >&2
    exit 0
  fi
  eval "$MAGICK_CMD"

  if [ $? -eq 0 ]; then
    echo "Success: Output saved to $OUTPUT" >&2
  else
    echo "Error: Command execution failed" >&2
    exit 1
  fi

}

case "$SUBCOMMAND" in
  level60 )
    magick "$IMAGE" -level 0%,60% "$OUTPUT"
    ;;
  level70 )
    magick "$IMAGE" -level 0%,70% "$OUTPUT"
    ;;
  level80 )
    magick "$IMAGE" -level 0%,80% "$OUTPUT"
    ;;
  x2 )
    magick "$IMAGE" -resize 200% "$OUTPUT"
    ;;
  x4 )
    magick "$IMAGE" -resize 400% "$OUTPUT"
    ;;
  ai )
    ai_subcommand
    ;;
  help | --help | -h )
    usage
    ;;
  * )
    echo "Unknown subcommand: $SUBCOMMAND"
    usage
    exit 1
    ;;
esac
