#!/usr/bin/env python

import json
import subprocess
import sys

import click
from litellm import completion
from pydantic import BaseModel, Field

LLM_CONFIG = json.loads(
    subprocess.run("llm-config", capture_output=True).stdout.decode("utf-8")
)


class CompletedResponse(BaseModel):
    text: str = Field(description="Corrected Chinese text")
    pinyin: str = Field(description="Pinyin representation of the corrected text")
    text_ja: str = Field(description="Japanese translation of the text")


class Response(BaseModel):
    model: str
    completed: CompletedResponse


class LLM:
    def __init__(self, provider: str, model: str):
        self.model = f"{provider}/{model}"

    def run(self, text: str) -> Response:
        system_prompt = f"""
入力される中国語を正しい普通の簡体字を用いたテキストに修正してください
ピンインも一緒に出力しましょう.

入力される文は次の点で誤ってる可能性があります

- 簡体字の代わりに日本の漢字を含むかもしれない. 簡体字に修正する
  - 例えば "図書館" は "图书馆"
- 部分的にピンインを含むかもしれない. 簡体字に修正する
  - 例えば "图shu馆" は "图书馆"
- 空白文字を含むかもしれない. 特にピンインの場合は tokenize されてるかもしれません. 出力からは消して下さい
- 日本語そのものを含むかもしれない. 中国語に正しく翻訳する. ただしここで日本語は (ja:日本語) の形式で入力される
  - 例えば "wo qule (ja:図書館)" は "我去了图书馆"

あなたの出力に関するルールです. これらに違反するとあなたの回答は不正扱いでゼロ点です.

- 句読点や約物について
  - 通常の英文のルールが原則
    - 句読点には半角文字の ,. を使う
    - 読点 , には半角スペース一つが続く
    - 句点 . の後ろに次の文が続くなら半角スペース一つを入れる
  - 句読点を追加したり削除しない
    - 入力文にある句読点をそのまま残す
  - 文末の！？には半角の !? を使う
- 中文はトークナイズされない
  - 複数の文が並ぶ場合に限り 句点 . と半角スペースが挟まる
- 拼音は適切にトークナイズする
  - 単語の単位で半角スペースを一つ挟む
- "ta" について
  - 文脈によって他/她/它を当てはめること
  - ただし入力では "ta1"（他）、"ta2"（她）、"ta3"（它） が使える
- 出力するピンイン
  - 声調記号を用いてください
  - "Zhōnghuá Rénmín Gònghéguó"

あなたが返すべき出力は一つの JSON 辞書です.
つまり {{ で始まって }} で終わる一行の文字列のみです.
これ以外のテキストを一切含めないことを厳守してください.

JSON の前後に余計なテキストを出力しないでください.
例えば ```json や ``` といった行を入れると不正扱いです.

あなたが返すJSONのフォーマットは次です

{{
    "model": "{self.model}",
    "completed": {{
        "text": "${{修正されたテキスト}}",
        "pinyin": "${{修正されたテキストに対応するピンイン表記}}",
        "text_ja": "${{テキストの和訳}}"
    }}
}}
"""
        messages = [
            {
                "role": "system",
                "content": system_prompt,
            },
            {
                "role": "user",
                "content": f"""
---
{text}
---
""",
            },
        ]
        result = completion(
            model=self.model,
            messages=messages,
            response_format=Response,
        )
        content: str = result.choices[0].message.content  # type: ignore
        return Response.model_validate_json(content)


@click.command()
@click.option(
    "--provider",
    "-p",
    type=click.Choice(["xai", "gemini", "openai", "anthropic"]),
    default=LLM_CONFIG["provider"],
    show_default=True,
)
@click.option(
    "--model",
    "-m",
    type=str,
    default=LLM_CONFIG["model"],
    show_default=True,
)
@click.argument("text", type=str, required=False)
def main(
    provider: str,
    model: str,
    text: str,
):
    if not text:
        text = sys.stdin.read()
    result = LLM(provider, model).run(text)
    print(result.model_dump_json())


if __name__ == "__main__":
    main()
